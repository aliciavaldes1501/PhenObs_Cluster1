---
title: "PhenObs analyses"
author: "Alicia Valdés"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  pdf_document:
    toc: yes
    toc_depth: 4
  html_document:
    toc: yes
    toc_depth: '4'
    df_print: paged
  word_document:
    toc: yes
    toc_depth: '4'
editor_options:
  chunk_output_type: inline
---

# Load libraries

```{r}
library(readr)
library(here)
library(rWCVP)
library(tidyverse)
library(purrr)
library(sf)
library(glmmTMB)
library(ggeffects)
library(taxize)
library(rgbif)
library(readxl)
library(gridExtra)
library(furrr)
```

# Occurrence matrices

## Package rWCVP

This package allows to access data from the World Checklist of Vascular Plants.

Read species list from PhenObs:

```{r}
species <- read_csv(here("data", "raw", "list_species_PhenObs.csv"))
species
```

```{r}
# taxonomy data
names <- rWCVPdata::wcvp_names

# distribution data
distributions <- rWCVPdata::wcvp_distributions
```

Filter the WCVP:

```{r}
# Filtering the WCVP to generate lists or summaries of vascular plant species 
# in particular areas. 
# Two arguments:
# taxon: the name of a valid taxon with a taxonomic rank of species or higher 
# (e.g. the species “Myrcia almasensis”, the genus “Myrcia”, or the family “Myrtaceae”).
# area: a vector of WGSRPD level 3 codes for the regions you want to focus on.
# These arguments can be combined in the wcvp_checklist, wcvp_occ_mat, 
# and wcvp_summary to generate outputs for focal taxa in a desired area. 

matches <- wcvp_match_names(species, name_col = "species", fuzzy = TRUE,
                            progress_bar = FALSE)

# Generate occurency matrix

# Extract the genus
genera <- species %>%
  mutate(genus = word(species, 1)) %>%
  distinct(genus) %>%
  pull(genus)
```

We want to get an occurrence matrix for all countries in Europe that are included in our RL data!

Read the RL data:

Read data:

```{r}
redlist <- read_tsv(here("data", "raw", "redlist_MOTIVATE_subset.csv"))
redlist
redlist %>% distinct(Country) %>% arrange(Country) %>% print(n = 50)
```

```{r}
area_codes = c(
  get_wgsrpd3_codes("Albania"),
  get_wgsrpd3_codes("Austria"), # Includes Austria and:
  # L4	AUT-LI	Liechtenstein
  get_wgsrpd3_codes("Baltic States"), # Includes:
  # L4	BLT-ES	Estonia
  # L4	BLT-LA	Latvia
  # L4	BLT-LI	Lithuania
  get_wgsrpd3_codes("Belarus"),
  get_wgsrpd3_codes("Belgium"), # Includes Belgium and:
  # L4	BGM-LU	Luxembourg
  get_wgsrpd3_codes("Bulgaria"),
  get_wgsrpd3_codes("Cyprus"),
  get_wgsrpd3_codes("Czechoslovakia"), # Includes:
  # L4	CZE-CZ	Czech Republic
  # L4	CZE-SL	Slovakia
  get_wgsrpd3_codes("Denmark"),
  get_wgsrpd3_codes("Finland"),
  get_wgsrpd3_codes("France"),
  get_wgsrpd3_codes("Germany"),
  get_wgsrpd3_codes("Greece"),
  get_wgsrpd3_codes("Hungary"),
  get_wgsrpd3_codes("Ireland"),
  get_wgsrpd3_codes("Italy"), # Includes Italy and:
  # L4	SIC-MA	Malta
  #   > get_wgsrpd3_codes("Sicilia")
  # ℹ Matches to input geography found at Area (Level 3)
  # [1] "SIC"
  # > get_wgsrpd3_codes("Italy")
  # ℹ Matches to input geography found at Area (Level 3) and Country (Gallagher)
  # [1] "ITA" "SAR" "SIC"
  get_wgsrpd3_codes("Netherlands"),
  get_wgsrpd3_codes("Norway"),
  get_wgsrpd3_codes("Poland"),
  get_wgsrpd3_codes("Portugal"),
  get_wgsrpd3_codes("Romania"),
  get_wgsrpd3_codes("Russia"),
  get_wgsrpd3_codes("Spain"), # Includes Spain and:
  # L4	SPA-AN  Andorra
  get_wgsrpd3_codes("Sweden"),
  get_wgsrpd3_codes("Switzerland"),
  get_wgsrpd3_codes("Turkey"),
  get_wgsrpd3_codes("Ukraine"), # Includes Ukraine and:
  # L4	UKR-MO	Moldova
  get_wgsrpd3_codes("Great Britain"), # Includes United Kingdom
  get_wgsrpd3_codes("Yugoslavia") # Includes:
  # L4	YUG-BH	Bosnia- Herzegovina
  # L4	YUG-CR	Croatia
  # L4	YUG-KO	Kosovo
  # L4	YUG-MN	Montenegro
  # L4	YUG-SE  Serbia
  # L4	YUG-SL	Slovenia
  )
```

```{r}
# Define safe wrapper for wcvp_occ_mat
# Apply wcvp_occ_mat to each genus
safe_occ_mat <- possibly(
  function(genus) {
    wcvp_occ_mat(
      taxon = genus,
      taxon_rank = "genus",
      area_codes = area_codes
    ) %>%
      mutate(input_genus = genus)
  },
  otherwise = NULL
)
```

```{r message=FALSE, warning=FALSE}
# Apply to all genera
occurrence_matrix_genera <- map_df(genera, safe_occ_mat)
occurrence_matrix_genera
```

```{r}
# Filter for species that are on the PhenObs list
occurrence_matrix_species <- occurrence_matrix_genera %>%
  filter(taxon_name %in% species$species)
nrow(occurrence_matrix_species) # 161 species of 177 in PhenObs list
```

Species from PhenObs list that were not matched:

```{r}
species %>% filter(!species %in% occurrence_matrix_species$taxon_name)
```

Species not appearing in any of the area_codes from PhenObs:

```{r}
wcvp_distribution(taxon ="Arnica longifolia", taxon_rank = "species") %>%
  wcvp_distribution_map() + ggtitle("Arnica longifolia")
wcvp_distribution(taxon ="Bergenia purpurascens", taxon_rank = "species") %>%
  wcvp_distribution_map() + ggtitle("Bergenia purpurascens")
wcvp_distribution(taxon ="Camassia cusickii", taxon_rank = "species") %>%
  wcvp_distribution_map() + ggtitle("Camassia cusickii")
wcvp_distribution(taxon ="Gunnera manicata", taxon_rank = "species") %>%
  wcvp_distribution_map() + ggtitle("Gunnera manicata")
wcvp_distribution(taxon ="Abelmoschus moschatus", taxon_rank = "species") %>%
  wcvp_distribution_map() + ggtitle("Abelmoschus moschatus")
wcvp_distribution(taxon ="Paeonia delavayi", taxon_rank = "species") %>%
  wcvp_distribution_map() + ggtitle("Paeonia delavayi")
wcvp_distribution(taxon = "Silphium integrifolium", taxon_rank = "species") %>%
  wcvp_distribution_map() + ggtitle("Silphium integrifolium")
wcvp_distribution(taxon = "Trillium sessile", taxon_rank = "species") %>%
  wcvp_distribution_map() + ggtitle("Trillium sessile")
```

Add synonyms:

```{r}
species <- species %>%
  mutate(synonym = case_when(
    species == "Anemone hepatica" ~ "Hepatica nobilis",
    species == "Anemone hupehensis" ~ "Eriocapitella hupehensis",
    species == "Atropa belladonna" ~ "Atropa bella-donna",
    species == "Centranthus ruber" ~ "Valeriana rubra",
    species == "Ficaria verna" ~ "Ranunculus ficaria",
    species == "Hibiscus moschatus" ~ "Abelmoschus moschatus",
    species == "Primula acaulis" ~ "Primula vulgaris",
    species == "Securigera varia" ~ "Coronilla varia",
    species == "Stachys officinalis" ~ "Betonica officinalis",
    TRUE ~ NA_character_
  ))
```

Redo generation of occurrence matrix:

```{r}
genera <- species %>%
  mutate(genus = ifelse(
    !is.na(synonym), word(synonym, 1),
    word(species, 1)
    )
    ) %>%
  distinct(genus) %>%
  pull(genus)
```

```{r message=FALSE, warning=FALSE}
# Apply to all genera
occurrence_matrix_genera <- map_df(genera, safe_occ_mat)
occurrence_matrix_genera
```

```{r}
# Filter for species that are on the PhenObs list
species <- species %>%
  mutate(species_corrected = ifelse(
    !is.na(synonym), synonym,
    species
  ))
occurrence_matrix_species <- occurrence_matrix_genera %>%
  filter(taxon_name %in% species$species_corrected)
nrow(occurrence_matrix_species) # 169 species of 177 in PhenObs list
```

Species from PhenObs list that were not matched

```{r}
# According to WCVP, these species are not appearing in any European country
species_absent <- species %>% 
  filter(!species_corrected %in% occurrence_matrix_species$taxon_name)
species_absent
species_present <-species %>%
  filter(species_corrected %in% occurrence_matrix_species$taxon_name)
species_present
```

Occurrence matrix for countries:

```{r}
occurrence_matrix_species_countries <- occurrence_matrix_species %>%
  select(-input_genus) %>%
  pivot_longer(cols = 3:59, names_to = "LEVEL3_COD") %>% 
  left_join(wgsrpd_mapping %>% select(LEVEL3_COD, COUNTRY) %>%
              # Remove one duplicate row
              distinct()) %>%
  group_by(taxon_name, COUNTRY) %>%
  summarise(occurrence = max(value), .groups = "drop")
```

## TO DO: GIFT R package

Allows to access data from the Global Inventory of Floras and Traits

## TO DO: rgbif package

Allows retrieving data from GBIF.

# Matching Phenobs - MOTIVATE Red List data

Do not only use the RL of the countries where we have our botanical gardens, instead use the RL from all available countries in Europe!

Try to match the full PhenObs spp list with the RL to see how many species are there in each category for each country.

Christoph: For matching of spp, standardize both sp_list and RL to the names currently used in GBIF before matching. In script for phylogenetic tree, but so far I cannot find it.

## Resolve full PhenObs spp list

Read the full PhenObs species list from 2022 data:

```{r}
sp_list <- read_excel("data/raw/full_list_sp_phenobs_2022.xlsx") %>%
  rename(species = Species) 
```

Resolve species to GBIF accepted names:

```{r}
length(sp_list$species) # 416
# Due to gna_verifier only being able to handle 50 names at once subsetting
spp1 <- sp_list$species[1:50]
spp2 <- sp_list$species[51:100]
spp3 <- sp_list$species[101:150]
spp4 <- sp_list$species[151:200]
spp5 <- sp_list$species[201:250]
spp6 <- sp_list$species[251:300]
spp7 <- sp_list$species[301:350]
spp8 <- sp_list$species[351:400]
spp9 <- sp_list$species[401:416]

# Unconventional way for getting current canonical names
resolved_1 <- gna_verifier(spp1, data_sources = 11) # 11 = GBIF Backbone Taxonomy
resolved_2 <- gna_verifier(spp2, data_sources = 11)
resolved_3 <- gna_verifier(spp3, data_sources = 11)
resolved_4 <- gna_verifier(spp4, data_sources = 11)
resolved_5 <- gna_verifier(spp5, data_sources = 11)
resolved_6 <- gna_verifier(spp6, data_sources = 11)
resolved_7 <- gna_verifier(spp7, data_sources = 11)
resolved_8 <- gna_verifier(spp8, data_sources = 11)
resolved_9 <- gna_verifier(spp9, data_sources = 11)


# Combining all of the names
all_resolved <- rbind(resolved_1, resolved_2, resolved_3, resolved_4, 
                      resolved_5, resolved_6, resolved_7, resolved_8,
                      resolved_9)

# Add to sp_list
sp_list_resolved <- sp_list %>%
  cbind(., all_resolved$currentCanonicalFull) %>%
  rename(name_res = `all_resolved$currentCanonicalFull`)
```

## Resolve RL

Resolve species (`sPlot concept unified`) to GBIF accepted names:

```{r}
length(unique(redlist$`sPlot concept unified`)) # 21096
# Due to gna_verifier only being able to handle 50 names at once subsetting
# Chunk the names into groups of <= 50
chunk_size <- 50
chunks <- split(unique(redlist$`sPlot concept unified`), 
                ceiling(seq_along(unique(redlist$`sPlot concept unified`)) / 
                          chunk_size))

# Helper to resolve one chunk using GBIF Backbone (data_sources = 11)
resolve_chunk_tbl <- function(x) {
  gna_verifier(
    names = x,
    data_sources = 11,       # GBIF Backbone Taxonomy
    all_matches = FALSE,     # best match only
    output_type = "table"
  )
}

# Try table output first
resolved_tbl <- tryCatch(
  {
    map(chunks, resolve_chunk_tbl) %>% bind_rows()
  },
  error = function(e) NULL
)
```

```{r}
resolved_tbl2 <- resolved_tbl %>%
  rename(
    rl_name_clean = submittedName,           
    name_res = currentCanonicalFull
  ) %>%
  # If duplicates exist in resolved_tbl (same submitted name multiple times),
  # keep the first/best one:
  distinct(rl_name_clean, .keep_all = TRUE)

redlist_with_clean <- redlist %>%
  mutate(
    rl_name_raw   = `sPlot concept unified`,
    rl_name_clean = str_squish(rl_name_raw)
  )

# Left-join: keep ALL rows from redlist
redlist_resolved <- redlist_with_clean %>%
  left_join(resolved_tbl2 %>%
              select(rl_name_clean, name_res), 
            by = "rl_name_clean")
```

## Join RL and full PhenObs spp list

```{r}
redlist_phenobs_all <- tibble(sp_list_resolved) %>%
  left_join(redlist_resolved) %>%
  # Keep columns that I think I will use
  select(name_res, Redlist_cat, Threat, Country, Publ_year, redlist_source, 
         Continent)
redlist_phenobs_all
```


## Resolve sensitivity PhenObs spp list

Resolve species to GBIF accepted names:

```{r}
length(species_present$species) # 169
# Due to gna_verifier only being able to handle 50 names at once subsetting
spp1 <- species_present$species[1:50]
spp2 <- species_present$species[51:100]
spp3 <- species_present$species[101:150]
spp4 <- species_present$species[151:169]

# Unconventional way for getting current canonical names
resolved_1 <- gna_verifier(spp1, data_sources = 11) # 11 = GBIF Backbone Taxonomy
resolved_2 <- gna_verifier(spp2, data_sources = 11)
resolved_3 <- gna_verifier(spp3, data_sources = 11)
resolved_4 <- gna_verifier(spp4, data_sources = 11)

# Combining all of the names
all_resolved <- rbind(resolved_1, resolved_2, resolved_3, resolved_4)

# Add to sp_list
species_present_resolved <- species_present %>%
  cbind(., all_resolved$currentCanonicalFull) %>%
  rename(name_res = `all_resolved$currentCanonicalFull`) %>%
  select(species, name_res)
```

## Join RL and sensitivity PhenObs spp list

```{r}
redlist_phenobs <- tibble(species_present_resolved) %>%
  left_join(redlist_resolved) %>%
  # Keep columns that I think I will use
  select(name_res, Redlist_cat, Threat, Country, Publ_year, redlist_source, 
         Continent)
redlist_phenobs
```

# Match country names

Make the country names in RL match with the country names in occurrence_matrix_species_countries:

```{r}
redlist_phenobs_all <- redlist_phenobs_all %>%
  mutate(Country_WGSRPD = case_when(
    Country == "Liechtenstein" ~ "Austria",
    Country %in% c("Estonia", "Latvia", "Lithuania")~ "Baltic States",
    Country == "Luxembourg" ~ "Belgium",
    Country %in% c("Czech Republic", "Slovakia") ~ "Czechoslovakia",
    Country == "Malta" ~ "Italy",
    Country == "Andorra" ~ "Spain",
    Country == "Moldova" ~ "Ukraine",
    Country == "United Kingdom" ~ "Great Britain",
    Country %in% c("Bosnia and Herzegovina", "Croatia", "Kosovo", "Montenegro",
                   "Serbia", "Slovenia") ~ "Yugoslavia",
    TRUE ~ Country))
```

```{r}
redlist_phenobs <- redlist_phenobs %>%
  mutate(Country_WGSRPD = case_when(
    Country == "Liechtenstein" ~ "Austria",
    Country %in% c("Estonia", "Latvia", "Lithuania")~ "Baltic States",
    Country == "Luxembourg" ~ "Belgium",
    Country %in% c("Czech Republic", "Slovakia") ~ "Czechoslovakia",
    Country == "Malta" ~ "Italy",
    Country == "Andorra" ~ "Spain",
    Country == "Moldova" ~ "Ukraine",
    Country == "United Kingdom" ~ "Great Britain",
    Country %in% c("Bosnia and Herzegovina", "Croatia", "Kosovo", "Montenegro",
                   "Serbia", "Slovenia") ~ "Yugoslavia",
    TRUE ~ Country))
```

```{r}
occurrence_matrix_species_countries %>% distinct(COUNTRY) %>% 
  arrange(COUNTRY) %>% print(n = 50)
redlist_phenobs %>% distinct(Country_WGSRPD) %>% arrange(Country_WGSRPD) %>% 
  print(n = 50)
# Turkey is in occurrence matrix, but not in RL,
# otherwise countries match
```

Cases where there is info for more than one year for a species and country:

```{r}
redlist_phenobs_dupl_diff <- redlist_phenobs %>%
  group_by(name_res, Country_WGSRPD) %>%
  filter(n() > 1, n_distinct(Threat) > 1) %>%
  ungroup()
redlist_phenobs_dupl_diff
```

Keep threat info for the latest publication year. In Russia, there is no info about publ year.

Keep Russia separated:

```{r}
redlist_phenobs_Russia <- redlist_phenobs %>%
  filter(Country_WGSRPD == "Russia")
```

Remove Russia:

```{r}
redlist_phenobs_noRussia <- redlist_phenobs %>%
  filter(Country_WGSRPD != "Russia")
```

For other countries apart from Russia: If there are several rows for same publ year, pick the most severe red list category.

```{r}
severity_order <- c("CR", "EN", "VU", "NT", "LC")

redlist_phenobs_noRussia_latest <- redlist_phenobs_noRussia %>%
  group_by(name_res, Country_WGSRPD) %>%
  filter(if (all(is.na(Publ_year))) TRUE else 
    Publ_year == max(Publ_year, na.rm = TRUE)) %>%
  slice(which.min(match(Redlist_cat, severity_order))) %>%
  ungroup()

redlist_phenobs_noRussia_latest
```

Check that there is only one entry for each species and country:

```{r}
redlist_phenobs_noRussia_latest %>% 
  group_by(name_res, Country_WGSRPD) %>%
  count() %>% filter(n > 1)
```

For Russia:

```{r}
severity_threatened <- c("CR", "EN", "VU")
severity_not_threatened <- c("NT", "LC")

redlist_phenobs_Russia <- redlist_phenobs_Russia %>%
  group_by(name_res) %>%
  # Apply custom logic to pick ONE row but keep all columns
  slice({
    threatened_count <- sum(Threat == "threatened")
    not_threatened_count <- sum(Threat == "not_threatened")
    
    # If there are more threatened rows than not threatened
    if (threatened_count > not_threatened_count) {
      # pick the first threatened row
      which.max(Threat == "threatened") 
      # Else if there are more not threatened rows
    } else if (not_threatened_count > threatened_count) {
      # pick the first not threatened row
      which.max(Threat == "not_threatened")
    } else {
      # If there is a tie between threatened and not threatened rows,
      # break by severity groups.
      # Count severity categories
      threatened_severity_count <- sum(Redlist_cat %in% severity_threatened)
      not_threatened_severity_count <- sum(Redlist_cat %in% severity_not_threatened)
      # If threatened severity count ≥ not threatened severity count
      if (threatened_severity_count >= not_threatened_severity_count) {
        # Picks the first row with CR/EN/VU
        which.max(Redlist_cat %in% severity_threatened)
        # Else
      } else {
        # Picks the first row with NT/LC
        which.max(Redlist_cat %in% severity_not_threatened)
      }
    }
  }) %>%
  ungroup()
```

For Russia, check that there is only one entry for each species:

```{r}
redlist_phenobs_Russia %>% group_by(name_res) %>%
  count() %>% filter(n > 1)
```

Join noRussia and Russia to get final RL for PhenObs:

```{r}
redlist_phenobs_final <- bind_rows(redlist_phenobs_noRussia_latest,
                                   redlist_phenobs_Russia)
# Note that species that are not threatened in any country 
# are absent from redlist_phenobs_final
```

# Join occurrence data and Red List data 

```{r}
occurrence_matrix_species_countries %>% distinct(COUNTRY)
redlist_phenobs_final %>% distinct(Country_WGSRPD)
```

Remove Turkey from occurrence_matrix_species_countries:

```{r}
occurrence_matrix_species_countries <- occurrence_matrix_species_countries %>%
  filter(COUNTRY != "Turkey")
```

## Resolve occurrence matrix

Resolve occurrence_matrix_species_countries$taxon_name to GBIF accepted names:

```{r}
length(unique(occurrence_matrix_species_countries$taxon_name)) # 169
# Due to gna_verifier only being able to handle 50 names at once subsetting
# Chunk the names into groups of <= 50
chunk_size <- 50
chunks <- split(unique(occurrence_matrix_species_countries$taxon_name), 
                ceiling(seq_along(unique(occurrence_matrix_species_countries$taxon_name)) / 
                          chunk_size))

# Try table output first
resolved_tbl <- tryCatch(
  {
    map(chunks, resolve_chunk_tbl) %>% bind_rows()
  },
  error = function(e) NULL
)
```

```{r}
resolved_tbl2 <- resolved_tbl %>%
  rename(
    occ_name_clean = submittedName,           
    name_res = currentCanonicalFull
  ) %>%
  # If duplicates exist in resolved_tbl (same submitted name multiple times),
  # keep the first/best one:
  distinct(occ_name_clean, .keep_all = TRUE)

occurrence_matrix_species_countries_with_clean <- occurrence_matrix_species_countries %>%
  mutate(
    occ_name_raw   = taxon_name,
    occ_name_clean = str_squish(occ_name_raw)
  )

# Left-join: keep ALL rows from occurrence_matrix_species_countries
occurrence_matrix_species_countries_resolved <- occurrence_matrix_species_countries_with_clean %>%
  left_join(resolved_tbl2 %>%
              select(occ_name_clean, name_res), 
            by = "occ_name_clean")
```

## Join ocurrence matrix and RL

```{r}
redlist_phenobs_final_occ <- 
  # Here, all 169 present species are included
  occurrence_matrix_species_countries_resolved %>% 
  select(name_res, COUNTRY, occurrence) %>%
  # Here, only the species included in red lists in ANY country are included
  left_join(redlist_phenobs_final, by = c("name_res" = "name_res",
                                        "COUNTRY" = "Country_WGSRPD")) %>%
  # Remove unneded columns
  select(-Redlist_cat, -Country, -Publ_year, -redlist_source, 
         -Continent) %>%
  # Rename
  rename(country = COUNTRY, threat = Threat) %>%
  # Order columns
  select(name_res, country, occurrence, threat) %>%
  # Set those where Threat is NA or not_evaluated_dd (only 2 spp in Russia)
  # as not_threatened
  mutate(threat = case_when(
    threat == "not_evaluated_dd" ~ "not_threatened",
    is.na(threat) ~ "not_threatened",
    TRUE ~ threat
  ))
```

# Calculate % endangerment

```{r}
perc_endangerment <- redlist_phenobs_final_occ %>%
  filter(occurrence > 0) %>%  # only countries where species is present
  group_by(name_res) %>%
  summarise(
    total_countries = n_distinct(country),
    threatened_countries = sum(threat == "threatened"),
    perc_endangerment = (threatened_countries / total_countries) * 100,
    .groups = "drop"
  ) %>%
  arrange(name_res) %>%
  # Have it also as a proportion
  mutate(prop_endangerment = perc_endangerment / 100)
perc_endangerment
```

# Sensitivity data

Slopes from Robert.

## Flowering

```{r}
sensitivity_data_fl <- read_csv(here("data", "raw", "slopes_20251128", "Overview_Slopes_Flowering.csv")) %>%
  select(-...1) 
```

### Resolve data

Resolve species to GBIF accepted names:

```{r}
length(sensitivity_data_fl$Species) # 171
# Due to gna_verifier only being able to handle 50 names at once subsetting
spp1 <- sensitivity_data_fl$Species[1:50]
spp2 <- sensitivity_data_fl$Species[51:100]
spp3 <- sensitivity_data_fl$Species[101:150]
spp4 <- sensitivity_data_fl$Species[151:171]

# Unconventional way for getting current canonical names
resolved_1 <- gna_verifier(spp1, data_sources = 11) # 11 = GBIF Backbone Taxonomy
resolved_2 <- gna_verifier(spp2, data_sources = 11)
resolved_3 <- gna_verifier(spp3, data_sources = 11)
resolved_4 <- gna_verifier(spp4, data_sources = 11)

# Combining all of the names
all_resolved <- rbind(resolved_1, resolved_2, resolved_3, resolved_4)

# Add to sp_list
sensitivity_data_fl_resolved <- sensitivity_data_fl %>%
  cbind(., all_resolved$currentCanonicalFull) %>%
  rename(name_res = `all_resolved$currentCanonicalFull`)
```

### Data manip

```{r}
sensitivity_data_fl_resolved <- sensitivity_data_fl_resolved %>%
  # Rename columns
  rename(mean_slope_fl = mean_slope, ci_lower_fl = ci_lower,
         ci_upper_fl = ci_upper, slope_var_fl = slope_var) %>%
  # Add variable for "sens" vs "not-sens"
  mutate(sens_01_fl = factor(ifelse(ci_lower_fl > 0 | ci_upper_fl < 0, 1, 0))) %>%
  # Calculate absolute value of mean slope
  mutate(mean_slope_abs_fl = abs(mean_slope_fl))
sensitivity_data_fl_resolved
```

## GSL

```{r}
sensitivity_data_GSL <- read_csv(here("data", "raw", "slopes_20251128", "Overview_Slopes_GSL.csv")) %>%
  select(-...1)
```

### Resolve data

Resolve species to GBIF accepted names:

```{r}
length(sensitivity_data_GSL$Species) # 154
# Due to gna_verifier only being able to handle 50 names at once subsetting
spp1 <- sensitivity_data_GSL$Species[1:50]
spp2 <- sensitivity_data_GSL$Species[51:100]
spp3 <- sensitivity_data_GSL$Species[101:150]
spp4 <- sensitivity_data_GSL$Species[151:154]

# Unconventional way for getting current canonical names
resolved_1 <- gna_verifier(spp1, data_sources = 11) # 11 = GBIF Backbone Taxonomy
resolved_2 <- gna_verifier(spp2, data_sources = 11)
resolved_3 <- gna_verifier(spp3, data_sources = 11)
resolved_4 <- gna_verifier(spp4, data_sources = 11)

# Combining all of the names
all_resolved <- rbind(resolved_1, resolved_2, resolved_3, resolved_4)

# Add to sp_list
sensitivity_data_GSL_resolved <- sensitivity_data_GSL %>%
  cbind(., all_resolved$currentCanonicalFull) %>%
  rename(name_res = `all_resolved$currentCanonicalFull`)
```

### Data manip

```{r}
sensitivity_data_GSL_resolved <- sensitivity_data_GSL_resolved %>%
  # Rename columns
  rename(mean_slope_GSL = mean_slope, ci_lower_GSL = ci_lower,
         ci_upper_GSL = ci_upper, slope_var_GSL= slope_var) %>%
  # Add variable for "sens" vs "not-sens"
  mutate(sens_01_GSL = factor(ifelse(ci_lower_GSL > 0 | ci_upper_GSL < 0, 1, 0))) %>%
  # Calculate absolute value of mean slope
  mutate(mean_slope_abs_GSL = abs(mean_slope_GSL))
sensitivity_data_GSL_resolved
```

# Prepare dataset for models

```{r}
sens_per_endanger <- perc_endangerment %>% 
  left_join(
    sensitivity_data_fl_resolved %>% 
      select(name_res, mean_slope_fl, sens_01_fl, mean_slope_abs_fl, ci_lower_fl,
             ci_upper_fl, slope_var_fl) 
    ) %>% 
  left_join(
    sensitivity_data_GSL_resolved %>% 
      select(name_res, mean_slope_GSL, sens_01_GSL, mean_slope_abs_GSL,
             ci_lower_GSL, ci_upper_GSL, slope_var_GSL)
    )
sens_per_endanger %>% filter(is.na(perc_endangerment))
sens_per_endanger %>% filter(is.na(mean_slope_fl))
sens_per_endanger %>% filter(is.na(mean_slope_GSL))
```

# Distributions

```{r}
ggplot(sens_per_endanger, aes(x = perc_endangerment)) +
  geom_histogram(color = "black", fill = "lightblue") +
  theme_bw() +
  xlab("% endangerment") + ylab("N species")

ggplot(sens_per_endanger, aes(x = mean_slope_fl)) +
  geom_histogram(color = "black", fill = "lightblue") +
  theme_bw() +
  xlab("Mean slope (flowering)") + ylab("N species")

ggplot(sens_per_endanger, aes(x = mean_slope_abs_fl)) +
  geom_histogram(color = "black", fill = "lightblue") +
  theme_bw() +
  xlab("Mean slope (absolute value) (flowering)") + ylab("N species")

ggplot(sens_per_endanger, aes(x = sens_01_fl)) +
  geom_histogram(color = "black", fill = "lightblue", stat = "count") +
  theme_bw() +
  xlab("Sensitivity (0/1) (flowering)") + ylab("N species")

ggplot(sens_per_endanger, aes(x = mean_slope_GSL)) +
  geom_histogram(color = "black", fill = "lightblue") +
  theme_bw() +
  xlab("Mean slope (GSL)") + ylab("N species")

ggplot(sens_per_endanger, aes(x = mean_slope_abs_GSL)) +
  geom_histogram(color = "black", fill = "lightblue") +
  theme_bw() +
  xlab("Mean slope (absolute value) (GSL)") + ylab("N species")

ggplot(sens_per_endanger, aes(x = sens_01_GSL)) +
  geom_histogram(color = "black", fill = "lightblue", stat = "count") +
  theme_bw() +
  xlab("Sensitivity (0/1) (GSL)") + ylab("N species")
```

# Models all Europe

## Filtering slope_var < 100

### Sensitive or not

```{r}
# perc_endangerment is in percentage, so use counts:
# successes = threatened_countries
# failures = total_countries - threatened_countries
model_threat_sens_01_fl_100 <- glmmTMB(
  cbind(threatened_countries, total_countries - threatened_countries) ~
    sens_01_fl, family = binomial, data = sens_per_endanger %>%
    filter(slope_var_fl < 100))
model_threat_sens_01_GSL_100 <- glmmTMB(
  cbind(threatened_countries, total_countries - threatened_countries) ~
    sens_01_GSL, family = binomial, data = sens_per_endanger %>%
    filter(slope_var_GSL < 100))
summary(model_threat_sens_01_fl_100)
summary(model_threat_sens_01_GSL_100)
```

#### Plot predictions

```{r}
ggplot() +
  geom_point(data = data.frame(ggpredict(model_threat_sens_01_fl_100)),
             aes(x = sens_01_fl.x, y = sens_01_fl.predicted), size = 3) +
  geom_errorbar(data = data.frame(ggpredict(model_threat_sens_01_fl_100)),
                aes(x = sens_01_fl.x, y = sens_01_fl.predicted, 
                    ymin = sens_01_fl.conf.low, ymax = sens_01_fl.conf.high),
                width = 0.25) +
  theme_bw() + ggtitle("p = 0.027") +
  xlab("Sensitivity (0/1) (flowering)") +
  ylab("Predicted probability of endangerment")
ggplot() +
  geom_point(data = data.frame(ggpredict(model_threat_sens_01_GSL_100)),
             aes(x = sens_01_GSL.x, y = sens_01_GSL.predicted), size = 3) +
  geom_errorbar(data = data.frame(ggpredict(model_threat_sens_01_GSL_100)),
                aes(x = sens_01_GSL.x, y = sens_01_GSL.predicted, 
                    ymin = sens_01_GSL.conf.low, ymax = sens_01_GSL.conf.high),
                width = 0.25) +
  theme_bw() + ggtitle("p = 0.069") +
  xlab("Sensitivity (0/1) (GSL)") +
  ylab("Predicted probability of endangerment")
```

### Mean slope flowering (absolute value - negative slopes)

```{r}
# Model without ZI
model_threat_mean_slope_neg_fl_100 <- glmmTMB(
  cbind(threatened_countries, total_countries - threatened_countries) ~
    mean_slope_abs_fl, family = binomial, 
  data = sens_per_endanger %>% filter(mean_slope_fl < 0 & slope_var_fl < 100))
# Model with ZI
model_threat_mean_slope_neg_fl_zi_100 <- glmmTMB(
  prop_endangerment ~ mean_slope_abs_fl, family = "beta_family", 
  ziformula=~.,
  data = sens_per_endanger %>% filter(mean_slope_fl < 0 & slope_var_fl < 100))
summary(model_threat_mean_slope_neg_fl_100)
summary(model_threat_mean_slope_neg_fl_zi_100)
```

#### Plot predictions

```{r}
# Model without ZI
ggplot() +
  geom_ribbon(data = data.frame(ggpredict(model_threat_mean_slope_neg_fl_100,
                                          terms="mean_slope_abs_fl [all]")),
            aes(x = x, y = predicted, ymin = conf.low, ymax = conf.high),
            alpha = 0.25, fill = "blue") +
  geom_line(data = data.frame(ggpredict(model_threat_mean_slope_neg_fl_100,
                                        terms="mean_slope_abs_fl [all]")),
            aes(x = x, y = predicted), color = "blue", linewidth = 1) +
  geom_point(data = sens_per_endanger %>%
               filter(mean_slope_fl < 0 & slope_var_fl < 100),
             aes(x = mean_slope_abs_fl, y = prop_endangerment), alpha = 0.6) +
  theme_bw() + ggtitle("p = 0.006") +
  xlab("Sensitivity (absolute value) (flowering)") +
  ylab("Predicted probability of endangerment")
# Model with ZI
grid.arrange(
  ggplot() +
    geom_ribbon(data = data.frame(ggpredict(model_threat_mean_slope_neg_fl_zi_100,
                                            type = "fixed",
                                            terms="mean_slope_abs_fl [all]")),
                aes(x = x, y = predicted, ymin = conf.low, ymax = conf.high),
                alpha = 0.25, fill = "blue") +
    geom_line(data = data.frame(ggpredict(model_threat_mean_slope_neg_fl_zi_100,
                                          type = "fixed",
                                          terms="mean_slope_abs_fl [all]")),
              aes(x = x, y = predicted), color = "blue", linewidth = 1) +
    geom_point(data = sens_per_endanger %>%
                 filter(mean_slope_fl < 0 & slope_var_fl < 100 &
                          prop_endangerment > 0),
               aes(x = mean_slope_abs_fl, y = prop_endangerment), alpha = 0.6) +
    theme_bw() + ggtitle("p = 0.012") +
    xlab("Sensitivity (absolute value) (flowering)") +
    ylab("Predicted probability of endangerment"),
  ggplot() +
    geom_ribbon(data = data.frame(ggpredict(model_threat_mean_slope_neg_fl_zi_100,
                                            type = "zi_prob",
                                            terms="mean_slope_abs_fl [all]")),
                aes(x = x, y = 1-predicted, ymin = 1-conf.low, 
                    ymax = 1-conf.high),
                alpha = 0.25, fill = "blue") +
    geom_line(data = data.frame(ggpredict(model_threat_mean_slope_neg_fl_zi_100,
                                          type = "zi_prob",
                                          terms="mean_slope_abs_fl [all]")),
              aes(x = x, y = 1-predicted), color = "blue", linewidth = 1) +
    geom_point(data = sens_per_endanger %>%
                 filter(mean_slope_fl < 0 & slope_var_fl < 100) %>%
                 mutate(endangerment_01 = ifelse(prop_endangerment == 0, 0, 1)),
               aes(x = mean_slope_abs_fl, y = endangerment_01), alpha = 0.6) +
    theme_bw() + ggtitle("p = 0.302") +
    xlab("Sensitivity (absolute value) (flowering)") +
    ylab("Predicted probability of being endangered"),
  ncol = 2)
```

### Mean slope GSL (quadratic model)

```{r}
# Model without ZI
model_threat_mean_slope_GSL_100 <- glmmTMB(
  cbind(threatened_countries, total_countries - threatened_countries) ~
    mean_slope_GSL + I(mean_slope_GSL^2), family = binomial, 
  data = sens_per_endanger %>% filter(slope_var_GSL < 100))
# Model with ZI
model_threat_mean_slope_GSL_zi_100 <- glmmTMB(
  prop_endangerment ~ mean_slope_GSL + I(mean_slope_GSL^2), 
  family = "beta_family", ziformula=~.,
  data = sens_per_endanger %>% filter(slope_var_GSL < 100))
summary(model_threat_mean_slope_GSL_100)
summary(model_threat_mean_slope_GSL_zi_100)
```

#### Plot predictions

```{r}
# Model without ZI
ggplot() +
  geom_ribbon(data = data.frame(ggpredict(model_threat_mean_slope_GSL_100,
                                          terms="mean_slope_GSL [all]")),
            aes(x = x, y = predicted, ymin = conf.low, ymax = conf.high),
            alpha = 0.25, fill = "blue") +
  geom_line(data = data.frame(ggpredict(model_threat_mean_slope_GSL_100,
                                        terms="mean_slope_GSL [all]")),
            aes(x = x, y = predicted), color = "blue", linewidth = 1) +
  geom_point(data = sens_per_endanger %>%
               filter(slope_var_GSL < 100),
             aes(x = mean_slope_GSL, y = prop_endangerment), alpha = 0.6) +
  theme_bw() + ggtitle("p = 0.030") +
  xlab("Sensitivity (GSL)") +
  ylab("Predicted probability of endangerment")
# Model with ZI
grid.arrange(
  ggplot() +
    geom_ribbon(data = data.frame(ggpredict(model_threat_mean_slope_GSL_zi_100,
                                            type = "fixed",
                                            terms="mean_slope_GSL [all]")),
                aes(x = x, y = predicted, ymin = conf.low, ymax = conf.high),
                alpha = 0.25, fill = "blue") +
    geom_line(data = data.frame(ggpredict(model_threat_mean_slope_GSL_zi_100,
                                          type = "fixed",
                                          terms="mean_slope_GSL [all]")),
              aes(x = x, y = predicted), color = "blue", linewidth = 1) +
    geom_point(data = sens_per_endanger %>%
                 filter(slope_var_GSL < 100 &
                          prop_endangerment > 0),
               aes(x = mean_slope_GSL, y = prop_endangerment), alpha = 0.6) +
    theme_bw() + ggtitle("p = 0.533") +
    xlab("Sensitivity (GSL)") +
    ylab("Predicted probability of endangerment"),
  ggplot() +
    geom_ribbon(data = data.frame(ggpredict(model_threat_mean_slope_GSL_zi_100,
                                            type = "zi_prob",
                                            terms="mean_slope_GSL [all]")),
                aes(x = x, y = 1-predicted, ymin = 1-conf.low, 
                    ymax = 1-conf.high),
                alpha = 0.25, fill = "blue") +
    geom_line(data = data.frame(ggpredict(model_threat_mean_slope_GSL_zi_100,
                                          type = "zi_prob",
                                          terms="mean_slope_GSL [all]")),
              aes(x = x, y = 1-predicted), color = "blue", linewidth = 1) +
    geom_point(data = sens_per_endanger %>%
                 filter(slope_var_GSL < 100) %>%
                 mutate(endangerment_01 = ifelse(prop_endangerment == 0, 0, 1)),
               aes(x = mean_slope_GSL, y = endangerment_01), alpha = 0.6) +
    theme_bw() + ggtitle("p = 0.137") +
    xlab("Sensitivity (GSL)") +
    ylab("Predicted probability of being endangered"),
  ncol = 2)
```

## Filtering slope_var < 50

### Sensitive or not

```{r}
# perc_endangerment is in percentage, so use counts:
# successes = threatened_countries
# failures = total_countries - threatened_countries
model_threat_sens_01_fl_50 <- glmmTMB(
  cbind(threatened_countries, total_countries - threatened_countries) ~
    sens_01_fl, family = binomial, data = sens_per_endanger %>%
    filter(slope_var_fl < 50))
model_threat_sens_01_GSL_50 <- glmmTMB(
  cbind(threatened_countries, total_countries - threatened_countries) ~
    sens_01_GSL, family = binomial, data = sens_per_endanger %>%
    filter(slope_var_GSL < 50))
summary(model_threat_sens_01_fl_50)
summary(model_threat_sens_01_GSL_50)
```

#### Plot predictions

```{r}
ggplot() +
  geom_point(data = data.frame(ggpredict(model_threat_sens_01_fl_50)),
             aes(x = sens_01_fl.x, y = sens_01_fl.predicted), size = 3) +
  geom_errorbar(data = data.frame(ggpredict(model_threat_sens_01_fl_50)),
                aes(x = sens_01_fl.x, y = sens_01_fl.predicted, 
                    ymin = sens_01_fl.conf.low, ymax = sens_01_fl.conf.high),
                width = 0.25) +
  theme_bw() + ggtitle("p = 0.065") +
  xlab("Sensitivity (0/1) (flowering)") +
  ylab("Predicted probability of endangerment")
ggplot() +
  geom_point(data = data.frame(ggpredict(model_threat_sens_01_GSL_50)),
             aes(x = sens_01_GSL.x, y = sens_01_GSL.predicted), size = 3) +
  geom_errorbar(data = data.frame(ggpredict(model_threat_sens_01_GSL_50)),
                aes(x = sens_01_GSL.x, y = sens_01_GSL.predicted, 
                    ymin = sens_01_GSL.conf.low, ymax = sens_01_GSL.conf.high),
                width = 0.25) +
  theme_bw() + ggtitle("p = 0.356") +
  xlab("Sensitivity (0/1) (GSL)") +
  ylab("Predicted probability of endangerment")
```

### Mean slope flowering (absolute value - negative slopes)

```{r}
# Model without ZI
model_threat_mean_slope_neg_fl_50 <- glmmTMB(
  cbind(threatened_countries, total_countries - threatened_countries) ~
    mean_slope_abs_fl, family = binomial, 
  data = sens_per_endanger %>% filter(mean_slope_fl < 0 & slope_var_fl < 50))
# Model with ZI
model_threat_mean_slope_neg_fl_zi_50 <- glmmTMB(
  prop_endangerment ~ mean_slope_abs_fl, family = "beta_family", 
  ziformula=~.,
  data = sens_per_endanger %>% filter(mean_slope_fl < 0 & slope_var_fl < 50))
summary(model_threat_mean_slope_neg_fl_50)
summary(model_threat_mean_slope_neg_fl_zi_50)
```

#### Plot predictions

```{r}
# Model without ZI
ggplot() +
  geom_ribbon(data = data.frame(ggpredict(model_threat_mean_slope_neg_fl_50,
                                          terms="mean_slope_abs_fl [all]")),
            aes(x = x, y = predicted, ymin = conf.low, ymax = conf.high),
            alpha = 0.25, fill = "blue") +
  geom_line(data = data.frame(ggpredict(model_threat_mean_slope_neg_fl_50,
                                        terms="mean_slope_abs_fl [all]")),
            aes(x = x, y = predicted), color = "blue", linewidth = 1) +
  geom_point(data = sens_per_endanger %>%
               filter(mean_slope_fl < 0 & slope_var_fl < 50),
             aes(x = mean_slope_abs_fl, y = prop_endangerment), alpha = 0.6) +
  theme_bw() + ggtitle("p = 0.008") +
  xlab("Sensitivity (absolute value) (flowering)") +
  ylab("Predicted probability of endangerment")
# Model with ZI
grid.arrange(
  ggplot() +
    geom_ribbon(data = data.frame(ggpredict(model_threat_mean_slope_neg_fl_zi_50,
                                            type = "fixed",
                                            terms="mean_slope_abs_fl [all]")),
                aes(x = x, y = predicted, ymin = conf.low, ymax = conf.high),
                alpha = 0.25, fill = "blue") +
    geom_line(data = data.frame(ggpredict(model_threat_mean_slope_neg_fl_zi_50,
                                          type = "fixed",
                                          terms="mean_slope_abs_fl [all]")),
              aes(x = x, y = predicted), color = "blue", linewidth = 1) +
    geom_point(data = sens_per_endanger %>%
                 filter(mean_slope_fl < 0 & slope_var_fl < 50 &
                          prop_endangerment > 0),
               aes(x = mean_slope_abs_fl, y = prop_endangerment), alpha = 0.6) +
    theme_bw() + ggtitle("p = 0.012") +
    xlab("Sensitivity (absolute value) (flowering)") +
    ylab("Predicted probability of endangerment"),
  ggplot() +
    geom_ribbon(data = data.frame(ggpredict(model_threat_mean_slope_neg_fl_zi_50,
                                            type = "zi_prob",
                                            terms="mean_slope_abs_fl [all]")),
                aes(x = x, y = 1-predicted, ymin = 1-conf.low, 
                    ymax = 1-conf.high),
                alpha = 0.25, fill = "blue") +
    geom_line(data = data.frame(ggpredict(model_threat_mean_slope_neg_fl_zi_50,
                                          type = "zi_prob",
                                          terms="mean_slope_abs_fl [all]")),
              aes(x = x, y = 1-predicted), color = "blue", linewidth = 1) +
    geom_point(data = sens_per_endanger %>%
                 filter(mean_slope_fl < 0 & slope_var_fl < 50) %>%
                 mutate(endangerment_01 = ifelse(prop_endangerment == 0, 0, 1)),
               aes(x = mean_slope_abs_fl, y = endangerment_01), alpha = 0.6) +
    theme_bw() + ggtitle("p = 0.789") +
    xlab("Sensitivity (absolute value) (flowering)") +
    ylab("Predicted probability of being endangered"),
  ncol = 2)
```

### Mean slope GSL (quadratic model)

```{r}
# Model without ZI
model_threat_mean_slope_GSL_50 <- glmmTMB(
  cbind(threatened_countries, total_countries - threatened_countries) ~
    mean_slope_GSL + I(mean_slope_GSL^2), family = binomial, 
  data = sens_per_endanger %>% filter(slope_var_GSL < 50))
# Model with ZI
model_threat_mean_slope_GSL_zi_50 <- glmmTMB(
  prop_endangerment ~ mean_slope_GSL + I(mean_slope_GSL^2), 
  family = "beta_family", ziformula=~.,
  data = sens_per_endanger %>% filter(slope_var_GSL < 50))
summary(model_threat_mean_slope_GSL_50)
summary(model_threat_mean_slope_GSL_zi_50)
```

#### Plot predictions

```{r}
# Model without ZI
ggplot() +
  geom_ribbon(data = data.frame(ggpredict(model_threat_mean_slope_GSL_50,
                                          terms="mean_slope_GSL [all]")),
            aes(x = x, y = predicted, ymin = conf.low, ymax = conf.high),
            alpha = 0.25, fill = "blue") +
  geom_line(data = data.frame(ggpredict(model_threat_mean_slope_GSL_50,
                                        terms="mean_slope_GSL [all]")),
            aes(x = x, y = predicted), color = "blue", linewidth = 1) +
  geom_point(data = sens_per_endanger %>%
               filter(slope_var_GSL < 50),
             aes(x = mean_slope_GSL, y = prop_endangerment), alpha = 0.6) +
  theme_bw() + ggtitle("p = 0.001") +
  xlab("Sensitivity (GSL)") +
  ylab("Predicted probability of endangerment")
# Model with ZI
grid.arrange(
  ggplot() +
    geom_ribbon(data = data.frame(ggpredict(model_threat_mean_slope_GSL_zi_50,
                                            type = "fixed",
                                            terms="mean_slope_GSL [all]")),
                aes(x = x, y = predicted, ymin = conf.low, ymax = conf.high),
                alpha = 0.25, fill = "blue") +
    geom_line(data = data.frame(ggpredict(model_threat_mean_slope_GSL_zi_50,
                                          type = "fixed",
                                          terms="mean_slope_GSL [all]")),
              aes(x = x, y = predicted), color = "blue", linewidth = 1) +
    geom_point(data = sens_per_endanger %>%
                 filter(slope_var_GSL < 50 &
                          prop_endangerment > 0),
               aes(x = mean_slope_GSL, y = prop_endangerment), alpha = 0.6) +
    theme_bw() + ggtitle("p = 0.395") +
    xlab("Sensitivity (GSL)") +
    ylab("Predicted probability of endangerment"),
  ggplot() +
    geom_ribbon(data = data.frame(ggpredict(model_threat_mean_slope_GSL_zi_50,
                                            type = "zi_prob",
                                            terms="mean_slope_GSL [all]")),
                aes(x = x, y = 1-predicted, ymin = 1-conf.low, 
                    ymax = 1-conf.high),
                alpha = 0.25, fill = "blue") +
    geom_line(data = data.frame(ggpredict(model_threat_mean_slope_GSL_zi_50,
                                          type = "zi_prob",
                                          terms="mean_slope_GSL [all]")),
              aes(x = x, y = 1-predicted), color = "blue", linewidth = 1) +
    geom_point(data = sens_per_endanger %>%
                 filter(slope_var_GSL < 50) %>%
                 mutate(endangerment_01 = ifelse(prop_endangerment == 0, 0, 1)),
               aes(x = mean_slope_GSL, y = endangerment_01), alpha = 0.6) +
    theme_bw() + ggtitle("p = 0.022") +
    xlab("Sensitivity (GSL)") +
    ylab("Predicted probability of being endangered"),
  ncol = 2)
```

# RL for Germany

```{r}
redlist_Germany <- redlist_phenobs_final %>%
  filter(Country == "Germany") %>%
  # Keep threat info for the latest publication year for each sp
  group_by(name_res) %>%
  filter(if (all(is.na(Publ_year))) TRUE else 
    Publ_year == max(Publ_year, na.rm = TRUE)) %>%
  slice(which.min(match(Redlist_cat, severity_order))) %>%
  ungroup()
```

Does not make sense to look at RL categories, cause there are 25 EN + 1 VU = 26 threatened, and 80 LC = 80 not threatened.

# Join occurrence data and RL for Germany

```{r}
redlist_Germany_occ <- 
  # Here, all 169 present species are included
  occurrence_matrix_species_countries_resolved %>% 
  filter(COUNTRY == "Germany") %>%
  # Here, only the species included in RL in Germany are included
  left_join(redlist_Germany, by = c("name_res" = "name_res",
                                          "COUNTRY" = "Country_WGSRPD")) %>%
  # Remove unneded columns
  select(-Redlist_cat, -Country, -Publ_year, -redlist_source, 
         - Continent) %>%
  # Rename
  rename(country = COUNTRY, threat = Threat) %>%
  # Order columns
  select(name_res, country, occurrence, threat) %>%
  # Set those where Threat is NA or not_evaluated_dd (only 2 spp in Russia)
  # as not_threatened
  mutate(threat = case_when(
    threat == "not_evaluated_dd" ~ "not_threatened",
    is.na(threat) ~ "not_threatened",
    TRUE ~ threat
  ))
```

```{r}
RL_threat_Germany <- redlist_Germany_occ %>%
  filter(occurrence > 0) %>% 
  select(name_res, threat)
```

# Prepare dataset for models

```{r}
sens_threat_Germany <- RL_threat_Germany %>% 
  mutate(threat = ifelse(threat == "threatened", 1, 0)) %>%
  left_join(
    sensitivity_data_fl_resolved %>% 
      select(name_res, mean_slope_fl, sens_01_fl, mean_slope_abs_fl, ci_lower_fl,
             ci_upper_fl, slope_var_fl) 
    ) %>%
  left_join(
    sensitivity_data_GSL_resolved %>% 
      select(name_res, mean_slope_GSL, sens_01_GSL, mean_slope_abs_GSL, 
             ci_lower_GSL, ci_upper_GSL, slope_var_GSL) 
    )
sens_threat_Germany %>% filter(is.na(threat))
sens_threat_Germany %>% filter(is.na(mean_slope_fl))
sens_threat_Germany %>% filter(is.na(mean_slope_GSL))
```

# Models for Germany

## Filtering slope_var < 100

### Sensitive or not

```{r}
# perc_endangerment is in percentage, so use counts:
# successes = threatened_countries
# failures = total_countries - threatened_countries
model_threat_sens_01_fl_100_G <- glmmTMB(
  threat ~ sens_01_fl, family = binomial, 
  data = sens_threat_Germany %>% filter(slope_var_fl < 100))
model_threat_sens_01_GSL_100_G <- glmmTMB(
  threat ~ sens_01_GSL, family = binomial, 
  data = sens_threat_Germany %>% filter(slope_var_GSL < 100))
summary(model_threat_sens_01_fl_100_G)
summary(model_threat_sens_01_GSL_100_G)
```

### Mean slope flowering (absolute value - negative slopes)

```{r}
model_threat_mean_slope_neg_fl_100_G <- glmmTMB(
  threat ~ mean_slope_abs_fl,
  family = binomial, 
  data = sens_threat_Germany %>% filter(mean_slope_fl < 0 & slope_var_fl < 100))
summary(model_threat_mean_slope_neg_fl_100_G)
```

### Mean slope GSL (quadratic model)

```{r}
model_threat_mean_slope_GSL_100_G <- glmmTMB(
  threat ~ mean_slope_GSL + I(mean_slope_GSL^2), family = binomial, 
  data = sens_threat_Germany %>% filter(slope_var_GSL < 100))
summary(model_threat_mean_slope_GSL_100_G)
```

## Filtering slope_var < 50

### Sensitive or not

```{r}
# perc_endangerment is in percentage, so use counts:
# successes = threatened_countries
# failures = total_countries - threatened_countries
model_threat_sens_01_fl_50_G <- glmmTMB(
  threat ~ sens_01_fl, family = binomial, 
  data = sens_threat_Germany %>% filter(slope_var_fl < 50))
model_threat_sens_01_GSL_50_G <- glmmTMB(
  threat ~ sens_01_GSL, family = binomial, 
  data = sens_threat_Germany %>% filter(slope_var_GSL < 50))
summary(model_threat_sens_01_fl_50_G)
summary(model_threat_sens_01_GSL_50_G)
```

### Mean slope flowering (absolute value - negative slopes)

```{r}
model_threat_mean_slope_neg_fl_50_G <- glmmTMB(
  threat ~ mean_slope_abs_fl,
  family = binomial, 
  data = sens_threat_Germany %>% filter(mean_slope_fl < 0 & slope_var_fl < 50))
summary(model_threat_mean_slope_neg_fl_50_G)
```

### Mean slope GSL (quadratic model)

```{r}
model_threat_mean_slope_GSL_50_G <- glmmTMB(
  threat ~ mean_slope_GSL + I(mean_slope_GSL^2), family = binomial, 
  data = sens_threat_Germany %>% filter(slope_var_GSL < 50))
summary(model_threat_mean_slope_GSL_50_G)
```

# Correlation mean slope flowering - GSL

```{r}
cor(sens_per_endanger$mean_slope_fl, sens_per_endanger$mean_slope_GSL,
    use = "complete.obs")
cor(sens_per_endanger$mean_slope_abs_fl, sens_per_endanger$mean_slope_abs_GSL,
    use = "complete.obs")
```

```{r}
ggplot(sens_per_endanger, aes(x = mean_slope_fl, y = mean_slope_GSL)) +
  geom_point() + geom_smooth()
ggplot(sens_per_endanger, aes(x = mean_slope_abs_fl, y = mean_slope_abs_GSL)) +
  geom_point() + geom_smooth()
```

# Stress tolerance

```{r}
stress <- read_delim(here("data", "raw", "Stress_Tolerance.csv"), delim = ";") %>%
  rename(stress_tol = `Stress tolerator score_percentage`)
stress
```

## Resolve

Resolve species to GBIF accepted names:

```{r}
length(stress$Species) # 263
# Due to gna_verifier only being able to handle 50 names at once subsetting
spp1 <- stress$Species[1:50]
spp2 <- stress$Species[51:100]
spp3 <- stress$Species[101:150]
spp4 <- stress$Species[151:200]
spp5 <- stress$Species[201:250]
spp6 <- stress$Species[251:263]

# Unconventional way for getting current canonical names
resolved_1 <- gna_verifier(spp1, data_sources = 11) # 11 = GBIF Backbone Taxonomy
resolved_2 <- gna_verifier(spp2, data_sources = 11)
resolved_3 <- gna_verifier(spp3, data_sources = 11)
resolved_4 <- gna_verifier(spp4, data_sources = 11)
resolved_5 <- gna_verifier(spp5, data_sources = 11)
resolved_6 <- gna_verifier(spp6, data_sources = 11)

# Combining all of the names
all_resolved <- rbind(resolved_1, resolved_2, resolved_3, resolved_4, 
                      resolved_5, resolved_6)

# Add to sp_list
stress_resolved <- stress %>%
  cbind(., all_resolved$currentCanonicalFull) %>%
  rename(name_res = `all_resolved$currentCanonicalFull`)
```

Join with sens_per_endanger:

```{r}
sens_per_endanger_stress <- sens_per_endanger %>%
  left_join(stress_resolved) %>%
  select(-Species)
```

```{r}
hist(sens_per_endanger_stress$stress_tol)
```

## Model stress tolerance

```{r}
model_threat_stress <- glmmTMB(
  cbind(threatened_countries, total_countries - threatened_countries) ~
    stress_tol, family = binomial, data = sens_per_endanger_stress)
summary(model_threat_stress)
```

## Models interaction stress tolerance * sensitivity

## Filtering slope_var < 100

### Sensitive or not

```{r}
model_threat_sens_01_fl_100_stress <- glmmTMB(
  cbind(threatened_countries, total_countries - threatened_countries) ~
    stress_tol * sens_01_fl, family = binomial, 
  data = sens_per_endanger_stress %>% filter(slope_var_fl < 100))
model_threat_sens_01_GSL_100_stress <- glmmTMB(
  cbind(threatened_countries, total_countries - threatened_countries) ~
    stress_tol * sens_01_GSL, family = binomial, 
  data = sens_per_endanger_stress %>% filter(slope_var_GSL < 100))
summary(model_threat_sens_01_fl_100_stress)
summary(model_threat_sens_01_GSL_100_stress)
```

### Mean slope flowering (absolute value - negative slopes)

```{r}
# Model without ZI
model_threat_mean_slope_neg_fl_100_stress <- glmmTMB(
  cbind(threatened_countries, total_countries - threatened_countries) ~
    stress_tol * mean_slope_abs_fl, family = binomial, 
  data = sens_per_endanger_stress %>% filter(mean_slope_fl < 0 & slope_var_fl < 100))
# Model with ZI
model_threat_mean_slope_neg_fl_zi_100_stress <- glmmTMB(
  prop_endangerment ~ stress_tol * mean_slope_abs_fl, family = "beta_family", 
  ziformula=~.,
  data = sens_per_endanger_stress %>% filter(mean_slope_fl < 0 & slope_var_fl < 100))
summary(model_threat_mean_slope_neg_fl_100_stress)
summary(model_threat_mean_slope_neg_fl_zi_100_stress)
```

### Mean slope GSL (quadratic model)

```{r}
# Model without ZI
model_threat_mean_slope_GSL_100_stress <- glmmTMB(
  cbind(threatened_countries, total_countries - threatened_countries) ~
    stress_tol * (mean_slope_GSL + I(mean_slope_GSL^2)), family = binomial, 
  data = sens_per_endanger_stress %>% filter(slope_var_GSL < 100))
# Model with ZI
model_threat_mean_slope_GSL_zi_100_stress <- glmmTMB(
  prop_endangerment ~ stress_tol * (mean_slope_GSL + I(mean_slope_GSL^2)), 
  family = "beta_family", ziformula=~.,
  data = sens_per_endanger_stress %>% filter(slope_var_GSL < 100))
summary(model_threat_mean_slope_GSL_100_stress)
summary(model_threat_mean_slope_GSL_zi_100_stress)
```

## Filtering slope_var < 50

### Sensitive or not

```{r}
model_threat_sens_01_fl_50_stress <- glmmTMB(
  cbind(threatened_countries, total_countries - threatened_countries) ~
    stress_tol * sens_01_fl, family = binomial, 
  data = sens_per_endanger_stress %>% filter(slope_var_fl < 50))
model_threat_sens_01_GSL_50_stress <- glmmTMB(
  cbind(threatened_countries, total_countries - threatened_countries) ~
    stress_tol * sens_01_GSL, family = binomial, 
  data = sens_per_endanger_stress %>% filter(slope_var_GSL < 50))
summary(model_threat_sens_01_fl_50_stress)
summary(model_threat_sens_01_GSL_50_stress)
```

### Mean slope flowering (absolute value - negative slopes)

```{r}
# Model without ZI
model_threat_mean_slope_neg_fl_50_stress <- glmmTMB(
  cbind(threatened_countries, total_countries - threatened_countries) ~
    stress_tol * mean_slope_abs_fl, family = binomial, 
  data = sens_per_endanger_stress %>% filter(mean_slope_fl < 0 & slope_var_fl < 50))
# Model with ZI
model_threat_mean_slope_neg_fl_zi_50_stress <- glmmTMB(
  prop_endangerment ~ stress_tol * mean_slope_abs_fl, family = "beta_family", 
  ziformula=~.,
  data = sens_per_endanger_stress %>% filter(mean_slope_fl < 0 & slope_var_fl < 50))
summary(model_threat_mean_slope_neg_fl_50_stress)
summary(model_threat_mean_slope_neg_fl_zi_50_stress)
```

### Mean slope GSL (quadratic model)

```{r}
# Model without ZI
model_threat_mean_slope_GSL_50_stress <- glmmTMB(
  cbind(threatened_countries, total_countries - threatened_countries) ~
    stress_tol * (mean_slope_GSL + I(mean_slope_GSL^2)), family = binomial, 
  data = sens_per_endanger_stress %>% filter(slope_var_GSL < 50))
# Model with ZI
model_threat_mean_slope_GSL_zi_50_stress <- glmmTMB(
  prop_endangerment ~ stress_tol * (mean_slope_GSL + I(mean_slope_GSL^2)), 
  family = "beta_family", ziformula=~.,
  data = sens_per_endanger_stress %>% filter(slope_var_GSL < 50))
summary(model_threat_mean_slope_GSL_50_stress)
summary(model_threat_mean_slope_GSL_zi_50_stress)
```

# Ellenberg tendency of chnage

```{r}
ellenberg <- read_excel(here("data", "raw", "IndicatorValues_Ellenberg.xlsx")) 
model_threat_sens_01_fl_100_stress
```

## Deal with non-numeric values in indicator values

Columns OEK_L - OEK_S and HAEUF_AE_change

```{r}
ellenberg <- ellenberg %>%
  mutate(across(OEK_L:OEK_S, ~ parse_number(.)))
```

## Duplicate species

```{r}
ellenberg %>% group_by(Art) %>% summarise(n = n()) %>% filter(n  > 1)
```

```{r}
ellenberg %>% filter(Art == "Veronica anagallis-aquatica anagallis")
```

HAEUF_AE_change is NA, so no problem!

## Resolve

```{r}
ellenberg <- ellenberg %>%
  mutate(Art = ifelse(Art == "Primula veris (officinalis)#f)", 
                      "Primula veris (officinalis)", Art))
```


```{r}
length(unique(ellenberg$Art)) # 2791
# Due to gna_verifier only being able to handle 50 names at once subsetting
# Chunk the names into groups of <= 50
chunks <- split(unique(ellenberg$Art), 
                ceiling(seq_along(unique(ellenberg$Art)) / 
                          chunk_size))
```

```{r}
resolved_tbl_list <- vector("list", length(chunks))
for (i in seq_along(chunks)) {
  cat("Resolving chunk", i, "of", length(chunks), 
      " (n =", length(chunks[[i]]), ")\n")
  res <- try(resolve_chunk_tbl(chunks[[i]]), silent = TRUE)
  if (inherits(res, "try-error")) {
    cat("Chunk", i, "failed with:\n", attr(res, "condition")$message, "\n")
    break
  }
  resolved_tbl_list[[i]] <- res
}
resolved_tbl <- dplyr::bind_rows(resolved_tbl_list)
```

```{r}
resolved_tbl2 <- resolved_tbl %>%
  rename(
    ellenberg_name_clean = submittedName,           
    name_res = currentCanonicalFull
  ) %>%
  # If duplicates exist in resolved_tbl (same submitted name multiple times),
  # keep the first/best one:
  distinct(ellenberg_name_clean, .keep_all = TRUE)

ellenberg_with_clean <- ellenberg %>%
  mutate(
    ellenberg_name_raw   = Art,
    ellenberg_name_clean = str_squish(ellenberg_name_raw)
  )

# Left-join: keep ALL rows from ellenberg
ellenberg_resolved <- ellenberg_with_clean %>%
  left_join(resolved_tbl2 %>%
              select(ellenberg_name_clean, name_res), 
            by = "ellenberg_name_clean") %>% select(-Art, -ellenberg_name_raw,
                                                    -ellenberg_name_clean)
```

Join with sens_per_endanger:

```{r}
sens_per_endanger_stress_ell <- sens_per_endanger_stress %>%
  left_join(ellenberg_resolved %>% 
              select(name_res, OEK_L:OEK_S, HAEUF_AE_change) %>%
              rename(change = HAEUF_AE_change))
```

## Relationships between indicator values

```{r}
model_ivs <- lm(change ~ OEK_L + OEK_T + OEK_K + OEK_F + OEK_R + OEK_N + OEK_S, 
             data = sens_per_endanger_stress_ell)
summary(model_ivs)
```

## Models tendency of change

### Filtering slope_var < 100

#### Sensitive or not

```{r}
model_ell_sens_01_fl_100 <- glmmTMB(change ~ sens_01_fl, 
                                    family = "poisson",
                                    data = sens_per_endanger_stress_ell %>%
                                      filter(slope_var_fl < 100))
model_ell_sens_01_GSL_100 <- glmmTMB(change ~ sens_01_GSL,  
                                    family = "poisson",
                                    data = sens_per_endanger_stress_ell %>%
                                      filter(slope_var_GSL < 100))
summary(model_ell_sens_01_fl_100)
summary(model_ell_sens_01_GSL_100)
```

#### Mean slope flowering (absolute value - negative slopes)

```{r}
# Model without ZI
model_ell__mean_slope_neg_fl_100 <- glmmTMB(change ~ mean_slope_abs_fl, 
                                    family = "poisson",
  data = sens_per_endanger_stress_ell %>% 
    filter(mean_slope_fl < 0 & slope_var_fl < 100))
# Model with ZI
model_ell__mean_slope_neg_fl_zi_100 <- glmmTMB(change ~ mean_slope_abs_fl,  
                                    family = "poisson",
                                               ziformula=~.,
  data = sens_per_endanger_stress_ell %>% 
    filter(mean_slope_fl < 0 & slope_var_fl < 100))
summary(model_ell__mean_slope_neg_fl_100)
summary(model_ell__mean_slope_neg_fl_zi_100)
```

#### Mean slope GSL (quadratic model)

```{r}
# Model without ZI
model_ell_mean_slope_GSL_100 <- glmmTMB(change ~ mean_slope_GSL + 
                                          I(mean_slope_GSL^2), 
                                    family = "poisson",
                                        data = sens_per_endanger_stress_ell %>% 
                                          filter(slope_var_GSL < 100))
# Model with ZI
model_ell_mean_slope_GSL_zi_100 <- glmmTMB(change ~ mean_slope_GSL + 
                                             I(mean_slope_GSL^2),  
                                    family = "poisson",
                                    ziformula=~.,
                                           data = sens_per_endanger_stress_ell %>% 
                                             filter(slope_var_GSL < 100))
summary(model_ell_mean_slope_GSL_100)
summary(model_ell_mean_slope_GSL_zi_100)
```

### Filtering slope_var < 50

#### Sensitive or not

```{r}
model_ell_sens_01_fl_50 <- glmmTMB(change ~ sens_01_fl,  
                                    family = "poisson",
                                    data = sens_per_endanger_stress_ell %>%
                                      filter(slope_var_fl < 50))
model_ell_sens_01_GSL_50 <- glmmTMB(change ~ sens_01_GSL,  
                                    family = "poisson",
                                    data = sens_per_endanger_stress_ell %>%
                                      filter(slope_var_GSL < 50))
summary(model_ell_sens_01_fl_50)
summary(model_ell_sens_01_GSL_50)
```

#### Mean slope flowering (absolute value - negative slopes)

```{r}
# Model without ZI
model_ell__mean_slope_neg_fl_50 <- glmmTMB(change ~ mean_slope_abs_fl, 
                                    family = "poisson",
  data = sens_per_endanger_stress_ell %>% 
    filter(mean_slope_fl < 0 & slope_var_fl < 50))
# Model with ZI
model_ell__mean_slope_neg_fl_zi_50 <- glmmTMB(change ~ mean_slope_abs_fl,  
                                    family = "poisson",
                                               ziformula=~.,
  data = sens_per_endanger_stress_ell %>% 
    filter(mean_slope_fl < 0 & slope_var_fl < 50))
summary(model_ell__mean_slope_neg_fl_50)
summary(model_ell__mean_slope_neg_fl_zi_50)
```

#### Mean slope GSL (quadratic model)

```{r}
# Model without ZI
model_ell_mean_slope_GSL_50 <- glmmTMB(change ~ mean_slope_GSL + 
                                          I(mean_slope_GSL^2), 
                                    family = "poisson",
                                        data = sens_per_endanger_stress_ell %>% 
                                          filter(slope_var_GSL < 50))
# Model with ZI
model_ell_mean_slope_GSL_zi_50 <- glmmTMB(change ~ mean_slope_GSL + 
                                             I(mean_slope_GSL^2), 
                                    family = "poisson",
                                    ziformula=~.,
                                           data = sens_per_endanger_stress_ell %>% 
                                             filter(slope_var_GSL < 50))
summary(model_ell_mean_slope_GSL_50)
summary(model_ell_mean_slope_GSL_zi_50)
```

# Session info

```{r}
sessionInfo()
```


